# Iframe Authentication Fix - Implementation Details

## Problem Identified
The embedded mode was failing because the SDK was trying to validate iframe JWT tokens using the standalone validation endpoint (`/standalone/validate`). Since the iframe tokens are generated by the parent application with different signing/validation requirements, they would fail validation at this endpoint.

## Solution Implemented

### 1. SDK Changes

#### Added new method: `loginWithIframeToken(token, userData)`
- This method specifically handles iframe authentication
- Skips backend validation since the token is already trusted (comes from parent)
- Directly sets the token and user data in the auth manager
- Available in both CommonJS and ESM builds

#### Modified `authenticateWithToken(token, skipValidation)`
- Added optional `skipValidation` parameter
- When `skipValidation=true` and JWT contains user data, uses the embedded user info
- Preserves backward compatibility for standalone mode

#### Made `AuthManager.setToken()` public
- Allows CreditSystem to directly set tokens for iframe mode
- Enables bypassing validation for trusted parent tokens

### 2. React App Changes

#### Updated `useCreditSystem` hook
- Changed from `creditSystem.loginWithToken()` to `creditSystem.loginWithIframeToken()`
- Passes both token and user data from parent
- Properly handles iframe authentication without backend validation

## How It Works Now

### Standalone Mode (unchanged)
1. User enters credentials
2. SDK validates with backend at `/standalone/auth`
3. Token is validated at `/standalone/validate`
4. Full authentication flow with backend

### Embedded/Iframe Mode (fixed)
1. React app detects it's in iframe
2. Requests JWT from parent via postMessage
3. Parent generates and sends JWT with user data
4. React app uses `loginWithIframeToken()` to authenticate
5. SDK accepts the token without backend validation
6. User is authenticated and can make API calls

## Testing the Fix

### Test Embedded Mode
1. Ensure parent Laravel app is logged in
2. Load the iframe page
3. Check browser console for:
   - `[UseCreditSystem] Iframe authentication successful`
   - `[SDK-CreditSystem] loginWithIframeToken() called`
4. User should be automatically authenticated without login prompt

### Test Standalone Mode
1. Open React app directly (not in iframe)
2. Login flow should work as before
3. Token validation happens normally through backend

## Files Modified

### SDK Files
- `/auth/AuthManager.js` - Added skipValidation parameter
- `/core/CreditSystem.js` - Added loginWithIframeToken method
- `/esm/auth/AuthManager.js` - ESM version updates
- `/esm/core/CreditSystem.js` - ESM version updates
- `/auth/AuthManager.d.ts` - TypeScript definitions
- `/core/CreditSystem.d.ts` - TypeScript definitions
- `/esm/auth/AuthManager.d.ts` - ESM TypeScript definitions
- `/esm/core/CreditSystem.d.ts` - ESM TypeScript definitions

### React App Files
- `/src/hooks/useCreditSystem.ts` - Use loginWithIframeToken for iframe auth

## Important Notes

1. **Security**: The iframe tokens are trusted because they come from the parent application. The parent is responsible for authentication and token generation.

2. **Backward Compatibility**: The changes are backward compatible. Existing implementations using `loginWithToken()` will continue to work.

3. **Token Expiry**: Iframe tokens still respect expiry times and will trigger re-authentication when expired.

4. **API Calls**: Once authenticated, all API calls work the same way regardless of authentication method.

## Deployment

1. Rebuild the SDK if needed
2. Update the React app to use the new SDK version
3. No changes needed to the parent Laravel application
4. Clear browser cache if testing locally

## Troubleshooting

If iframe authentication still fails:
1. Check parent is sending token with user data
2. Verify CORS settings in parent's .env
3. Check browser console for specific error messages
4. Ensure JWT contains user object in payload